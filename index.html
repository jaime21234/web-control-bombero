<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Control de Personal - Bomberos</title>
    <style>
      :root {
        --bg: #0f1116;
        --bg-soft: #151920;
        --fg: #e6e9ef;
        --fg-dim: #9aa1ad;
        --primary: #3b82f6;
        --danger: #ef4444;
        --warning: #f59e0b;
        --success: #10b981;
        --border: #232833;
        --radius: 12px;
      }
      body {
        background: var(--bg);
        color: var(--fg);
        font-family:
          system-ui,
          -apple-system,
          Segoe UI,
          Roboto,
          Ubuntu,
          Cantarell,
          sans-serif;
        line-height: 1.5;
        padding: 24px 12px 64px;
      }
      h1,
      h2,
      h3 {
        margin: 0 0 16px;
        font-weight: 600;
      }
      .container {
        max-width: 1100px;
        margin: 0 auto;
      }
      .card {
        background: var(--bg-soft);
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.02) inset;
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
      }
      .tab-btn {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--fg);
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
      }
      .tab-btn.active {
        background: var(--primary);
        border-color: var(--primary);
      }
      .hidden {
        display: none !important;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
      }
      th,
      td {
        padding: 8px 10px;
        border-bottom: 1px solid #1e222b;
      }
      th {
        background: #11151d;
        position: sticky;
        top: 0;
        z-index: 1;
        text-align: left;
      }
      .status-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.75rem;
      }
      .status-on {
        background: rgba(16, 185, 129, 0.1);
        color: var(--success);
        border: 1px solid rgba(16, 185, 129, 0.3);
      }
      .status-off {
        background: rgba(239, 68, 68, 0.08);
        color: var(--danger);
        border: 1px solid rgba(239, 68, 68, 0.25);
      }
      .role-badge {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 0.75rem;
        background: #1c1f27;
        color: #aeb6c5;
        border: 1px solid #222733;
        margin-left: 6px;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 12px;
      }
      .stat {
        background: #11151d;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px 14px;
      }
      .stat h3 {
        font-size: 0.85rem;
        color: var(--fg-dim);
        margin-bottom: 6px;
      }
      .stat .num {
        font-size: 1.4rem;
        font-weight: 700;
      }
      button {
        background: var(--primary);
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        cursor: pointer;
      }
      .btn-outline {
        background: transparent;
        border: 1px solid var(--border);
        color: var(--fg);
      }
      .btn-danger {
        background: var(--danger);
      }
      .btn-warning {
        background: var(--warning);
        color: #000;
      }
      .row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }
      .col {
        flex: 1;
        min-width: 240px;
      }
      input,
      select,
      textarea {
        width: 100%;
        background: #0d0f14;
        color: var(--fg);
        border: 1px solid var(--border);
        border-radius: 6px;
        padding: 8px 10px;
        font-size: 1rem;
        outline: none;
        margin-bottom: 10px;
      }
      input:focus,
      select:focus,
      textarea:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.15);
      }
      .avatar {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--border);
        background: #11151d;
      }
      .muted {
        color: var(--fg-dim);
        font-size: 0.85rem;
      }
      .hist-table td {
        white-space: nowrap;
      }
      .center {
        text-align: center;
      }
      .label-inline {
        display: inline-block;
        min-width: 120px;
        color: var(--fg-dim);
      }
      .logo {
        width: 60px;
        vertical-align: middle;
        margin-right: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>
        <img
          src="https://via.placeholder.com/60x60?text=Logo"
          class="logo"
          alt="Logo"
        />Control de Personal <span class="role-badge">Bomberos</span>
      </h1>
      <div class="tabs">
        <button class="tab-btn active" data-tab="inicioTab">Inicio</button>
        <button class="tab-btn" data-tab="perfilTab">Perfil</button>
        <button class="tab-btn" data-tab="adminTab">Admin</button>
      </div>
      <section id="inicioTab" class="card">
        <h2>Dashboard</h2>
        <div class="grid" id="statsGrid"></div>
        <h3 style="margin-top: 24px">En servicio ahora</h3>
        <div id="enServicioAhora"></div>
        <h3 style="margin-top: 24px">Todos los bomberos</h3>
        <input
          type="text"
          id="buscarBombero"
          placeholder="Buscar por nombre..."
          style="
            margin-bottom: 10px;
            padding: 8px;
            width: 100%;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: #0d0f14;
            color: var(--fg);
          "
        />
        <div style="overflow: auto; max-height: 50vh">
          <table id="tablaTodos"></table>
        </div>
      </section>
      <section id="perfilTab" class="card hidden">
        <!-- Sección de perfil -->
        <h2>Acceso a perfil</h2>
        <div id="perfilLogin">
          <p class="muted">Ingresa tu código/RUT y tu PIN personal</p>
          <div class="row">
            <div class="col">
              <label>ID</label><input type="text" id="loginId" />
            </div>
            <div class="col">
              <label>PIN</label><input type="password" id="loginPin" />
            </div>
          </div>
          <button id="btnPerfilLogin">Entrar</button>
          <span id="perfilLoginMsg" class="status error"></span>
        </div>
        <div id="perfilView" class="hidden">
          <div class="row" style="align-items: center">
            <div class="col center" style="max-width: 200px">
              <img id="perfilFoto" class="avatar" alt="Foto" />
            </div>
            <div class="col">
              <div>
                <span class="label-inline">Nombre:</span>
                <strong id="perfilNombre"></strong>
              </div>
              <div>
                <span class="label-inline">Categoría:</span>
                <span id="perfilCategoria"></span>
              </div>
              <div>
                <span class="label-inline">Compañía:</span>
                <span id="perfilCompania"></span>
              </div>
              <div>
                <span class="label-inline">Estado:</span>
                <span id="perfilEstado"></span>
              </div>
              <div>
                <span class="label-inline">Total servicio:</span>
                <span id="perfilTotal"></span>
              </div>
              <div>
                <span class="label-inline">Ingreso:</span>
                <span id="perfilIngreso"></span>
              </div>
              <div>
                <span class="label-inline">Antigüedad:</span>
                <span id="perfilAntiguedad"></span>
              </div>
              <div>
                <span class="label-inline">Cursos:</span>
                <span id="perfilCursos"></span>
              </div>
            </div>
          </div>
          <div style="margin: 16px 0">
            <button id="btnToggleServicio" class="btn-warning"></button>
            <button
              id="btnSalirPerfil"
              class="btn-outline"
              style="margin-left: 8px"
            >
              Cerrar sesión
            </button>
          </div>
          <h3>Historial de servicio</h3>
          <div style="overflow: auto; max-height: 40vh">
            <table id="tablaHistorial" class="hist-table">
              <thead>
                <tr>
                  <th>Inicio</th>
                  <th>Fin</th>
                  <th>Duración</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>
      <section id="adminTab" class="card hidden">
        <!-- Sección admin -->
        <h2>Administrador</h2>
        <div id="adminLogin">
          <p class="muted">
            Ingresa la contraseña de administrador para crear/editar bomberos.
          </p>
          <input
            type="password"
            id="adminPass"
            placeholder="Contraseña admin"
          />
          <button id="btnAdminLogin">Entrar</button>
          <span id="adminLoginMsg" class="status error"></span>
        </div>
        <div id="adminPanel" class="hidden">
          <button id="btnAdminLogout" class="btn-outline">
            Cerrar sesión admin
          </button>
          <h3 style="margin-top: 16px">Agregar / Editar bombero</h3>
          <form id="adminForm">
            <div class="row">
              <div class="col">
                <label>ID (único, ej: RUT)</label
                ><input type="text" name="id" required />
              </div>
              <div class="col">
                <label>Nombre</label
                ><input type="text" name="nombre" required />
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label>Categoría</label>
                <select name="categoria" required>
                  <option value="Operativo">Operativo</option>
                  <option value="Inactivo">Inactivo</option>
                  <option value="Honorario">Honorario</option>
                </select>
              </div>
              <div class="col">
                <label>Compañía</label>
                <select name="compania" required>
                  <option value="Primera Compañía">Primera Compañía</option>
                  <option value="Segunda Compañía">Segunda Compañía</option>
                </select>
              </div>
            </div>
            <div class="row">
              <div class="col">
                <label>PIN</label><input type="text" name="pin" required />
              </div>
            </div>
            <label>URL Foto (opcional)</label><input type="url" name="foto" />
            <label>Cursos (separados por coma)</label
            ><input
              type="text"
              name="cursos"
              placeholder="Ej: Rescate, Incendios"
            />
            <button type="submit">Guardar</button>
            <span id="adminFormMsg" class="status"></span>
          </form>
          <h3 style="margin-top: 24px">Listado (para editar)</h3>
          <div style="overflow: auto; max-height: 40vh">
            <table id="adminTable"></table>
          </div>
        </div>
      </section>
    </div>

    <script>
      const ADMIN_PASS = "admin2025";
      const STORAGE_KEY = "personal_bomberos_v1";
      const $ = (s) => document.querySelector(s);
      const $$ = (s) => document.querySelectorAll(s);

      function nowISO() {
        return new Date().toISOString();
      }
      function fmtDateTime(iso) {
        if (!iso) return "-";
        const d = new Date(iso),
          pad = (n) => String(n).padStart(2, "0");
        return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
      }
      function msToHuman(ms) {
        const sec = Math.floor(ms / 1000),
          h = Math.floor(sec / 3600),
          m = Math.floor((sec % 3600) / 60),
          s = sec % 60,
          pad = (n) => String(n).padStart(2, "0");
        return `${pad(h)}:${pad(m)}:${pad(s)}`;
      }
      function tiempoAntiguedad(ms) {
        const dias = Math.floor(ms / (1000 * 60 * 60 * 24));
        if (dias < 7) return `${dias} día(s)`;
        if (dias < 30) return `${Math.floor(dias / 7)} semana(s)`;
        if (dias < 365) return `${Math.floor(dias / 30)} mes(es)`;
        return `${Math.floor(dias / 365)} año(s)`;
      }

      function loadData() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) return JSON.parse(raw);
        const demo = [
          {
            id: "11111111-1",
            nombre: "Juan Pérez",
            categoria: "operativo",
            compania: "Primera Compañía",
            estado: "fuera",
            enServicioDesde: null,
            totalMs: 0,
            historial: [],
            pin: "1234",
            foto: "",
            fechaIngreso: nowISO(),
            cursos: [],
          },
          {
            id: "22222222-2",
            nombre: "María López",
            categoria: "honorario",
            compania: "Segunda Compañía",
            estado: "fuera",
            enServicioDesde: null,
            totalMs: 0,
            historial: [],
            pin: "5678",
            foto: "",
            fechaIngreso: nowISO(),
            cursos: [],
          },
        ];
        saveData(demo);
        return demo;
      }
      function saveData(arr) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
      }

      let personal = loadData(),
        currentUser = null,
        elapsedInterval = null;

      $$(".tab-btn").forEach((btn) =>
        btn.addEventListener("click", () => {
          $$(".tab-btn").forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          ["inicioTab", "perfilTab", "adminTab"].forEach((id) => {
            $("#" + id).classList.toggle("hidden", id !== btn.dataset.tab);
          });
          if (btn.dataset.tab === "inicioTab") renderDashboard();
        }),
      );

      function renderDashboard() {
        const total = personal.length;
        const enServicio = personal.filter((p) => p.estado === "en").length;
        const operativos = personal.filter(
          (p) => p.categoria === "operativo",
        ).length;
        const inactivos = personal.filter(
          (p) => p.categoria === "inactivo",
        ).length;
        const honorarios = personal.filter(
          (p) => p.categoria === "honorario",
        ).length;
        $("#statsGrid").innerHTML =
          `<div class="stat"><h3>Total personal</h3><div class="num">${total}</div></div>
     <div class="stat"><h3>En servicio</h3><div class="num">${enServicio}</div></div>
     <div class="stat"><h3>Operativos</h3><div class="num">${operativos}</div></div>
     <div class="stat"><h3>Inactivos</h3><div class="num">${inactivos}</div></div>
     <div class="stat"><h3>Honorarios</h3><div class="num">${honorarios}</div></div>`;
        const actives = personal.filter((p) => p.estado === "en");
        if (!actives.length) {
          $("#enServicioAhora").innerHTML =
            '<p class="muted">Nadie en servicio actualmente.</p>';
        } else {
          let html = `<table><thead><tr><th>Nombre</th><th>Categoría</th><th>Compañía</th><th>Desde</th><th>Tiempo actual</th></tr></thead><tbody>`;
          actives.forEach((p) => {
            html += `<tr>
        <td>${p.nombre}</td>
        <td>${p.categoria}</td>
        <td>${p.compania}</td>
        <td>${fmtDateTime(p.enServicioDesde)}</td>
        <td data-start="${p.enServicioDesde}" class="elapsedCell"></td>
      </tr>`;
          });
          html += "</tbody></table>";
          $("#enServicioAhora").innerHTML = html;
        }
        let html2 = `<thead><tr><th>Nombre</th><th>Categoría</th><th>Compañía</th><th>Estado</th><th>Total Servicio</th></tr></thead><tbody>`;
        personal.forEach((p) => {
          const estadoBadge =
            p.estado === "en"
              ? '<span class="status-badge status-on">En servicio</span>'
              : '<span class="status-badge status-off">Fuera</span>';
          let total = p.totalMs;
          if (p.estado === "en" && p.enServicioDesde)
            total += Date.now() - new Date(p.enServicioDesde).getTime();
          html2 += `<tr>
      <td>${p.nombre}</td>
      <td>${p.categoria}</td>
      <td>${p.compania}</td>
      <td>${estadoBadge}</td>
      <td>${msToHuman(total)}</td>
    </tr>`;
        });
        html2 += "</tbody>";
        $("#tablaTodos").innerHTML = html2;
        startElapsedTicker();
      }

      // --- Buscador ---
      $("#buscarBombero").addEventListener("input", function () {
        const filtro = this.value.toLowerCase();
        const filas = $("#tablaTodos").querySelectorAll("tbody tr");
        filas.forEach((fila) => {
          const nombre = fila.querySelector("td").textContent.toLowerCase();
          fila.style.display = nombre.includes(filtro) ? "" : "none";
        });
      });
      // --- Fin Buscador ---

      function startElapsedTicker() {
        if (elapsedInterval) clearInterval(elapsedInterval);
        elapsedInterval = setInterval(() => {
          $$(".elapsedCell").forEach((td) => {
            const start = td.getAttribute("data-start");
            td.textContent = start
              ? msToHuman(Date.now() - new Date(start).getTime())
              : "-";
          });
        }, 1000);
      }

      // Resto de código (perfil y admin)...
      $("#btnPerfilLogin").addEventListener("click", () => {
        const id = $("#loginId").value.trim(),
          pin = $("#loginPin").value.trim();
        const user = personal.find((p) => p.id === id && p.pin === pin);
        if (!user) {
          $("#perfilLoginMsg").textContent = "ID o PIN incorrectos.";
          return;
        }
        currentUser = user;
        $("#perfilLoginMsg").textContent = "";
        $("#perfilLogin").classList.add("hidden");
        $("#perfilView").classList.remove("hidden");
        renderPerfil();
      });

      $("#btnSalirPerfil").addEventListener("click", () => {
        currentUser = null;
        $("#perfilView").classList.add("hidden");
        $("#perfilLogin").classList.remove("hidden");
        $("#loginId").value = "";
        $("#loginPin").value = "";
      });

      function renderPerfil() {
        if (!currentUser) return;
        $("#perfilNombre").textContent = currentUser.nombre;
        $("#perfilCategoria").textContent = currentUser.categoria;
        $("#perfilCompania").textContent = currentUser.compania;
        $("#perfilEstado").innerHTML =
          currentUser.estado === "en"
            ? '<span class="status-badge status-on">En servicio</span>'
            : '<span class="status-badge status-off">Fuera</span>';
        let total = currentUser.totalMs;
        if (currentUser.estado === "en" && currentUser.enServicioDesde)
          total += Date.now() - new Date(currentUser.enServicioDesde).getTime();
        $("#perfilTotal").textContent = msToHuman(total);
        $("#perfilIngreso").textContent = fmtDateTime(currentUser.fechaIngreso);
        const antig = new Date() - new Date(currentUser.fechaIngreso);
        $("#perfilAntiguedad").textContent = tiempoAntiguedad(antig);
        $("#perfilCursos").textContent =
          (currentUser.cursos || []).join(", ") || "-";
        $("#perfilFoto").src =
          currentUser.foto || "https://via.placeholder.com/120?text=Foto";

        // Historial
        let html = "";
        (currentUser.historial || []).forEach((h) => {
          const ini = fmtDateTime(h.inicio);
          const fin = h.fin ? fmtDateTime(h.fin) : "-";
          const dur = h.fin
            ? msToHuman(new Date(h.fin) - new Date(h.inicio))
            : "-";
          html += `<tr><td>${ini}</td><td>${fin}</td><td>${dur}</td></tr>`;
        });
        $("#tablaHistorial tbody").innerHTML = html;

        // Botón para cambiar estado servicio
        if (currentUser.estado === "en") {
          $("#btnToggleServicio").textContent = "Marcar fuera de servicio";
          $("#btnToggleServicio").classList.remove("btn-warning");
          $("#btnToggleServicio").classList.add("btn-danger");
        } else {
          $("#btnToggleServicio").textContent = "Marcar en servicio";
          $("#btnToggleServicio").classList.remove("btn-danger");
          $("#btnToggleServicio").classList.add("btn-warning");
        }
      }

      $("#btnToggleServicio").addEventListener("click", () => {
        if (!currentUser) return;
        if (currentUser.estado === "en") {
          // Marcar fuera
          if (currentUser.enServicioDesde) {
            const fin = nowISO();
            currentUser.historial.push({
              inicio: currentUser.enServicioDesde,
              fin,
            });
            currentUser.totalMs +=
              new Date(fin) - new Date(currentUser.enServicioDesde);
            currentUser.enServicioDesde = null;
          }
          currentUser.estado = "fuera";
        } else {
          // Marcar en servicio
          currentUser.enServicioDesde = nowISO();
          currentUser.estado = "en";
        }
        saveData(personal);
        renderPerfil();
        renderDashboard();
      });

      // --- ADMIN ---

      $("#btnAdminLogin").addEventListener("click", () => {
        const pass = $("#adminPass").value;
        if (pass === ADMIN_PASS) {
          $("#adminLoginMsg").textContent = "";
          $("#adminLogin").classList.add("hidden");
          $("#adminPanel").classList.remove("hidden");
          renderAdminTable();
        } else {
          $("#adminLoginMsg").textContent = "Contraseña incorrecta.";
        }
      });

      $("#btnAdminLogout").addEventListener("click", () => {
        $("#adminPass").value = "";
        $("#adminLoginMsg").textContent = "";
        $("#adminLogin").classList.remove("hidden");
        $("#adminPanel").classList.add("hidden");
      });

      function renderAdminTable() {
        let html = `<thead><tr><th>ID</th><th>Nombre</th><th>Categoría</th><th>Compañía</th><th>PIN</th><th>Acciones</th></tr></thead><tbody>`;
        personal.forEach((p) => {
          html += `<tr>
      <td>${p.id}</td>
      <td>${p.nombre}</td>
      <td>${p.categoria}</td>
      <td>${p.compania}</td>
      <td>${p.pin}</td>
      <td>
        <button class="btn-outline" onclick="editBombero('${p.id}')">Editar</button>
        <button class="btn-danger" onclick="deleteBombero('${p.id}')">Eliminar</button>
      </td>
    </tr>`;
        });
        html += "</tbody>";
        $("#adminTable").innerHTML = html;
      }

      function editBombero(id) {
        const p = personal.find((x) => x.id === id);
        if (!p) return alert("No encontrado");
        const form = $("#adminForm");
        form.id.value = p.id;
        form.nombre.value = p.nombre;
        form.categoria.value = p.categoria;
        form.compania.value = p.compania;
        form.pin.value = p.pin;
        form.foto.value = p.foto || "";
        form.cursos.value = (p.cursos || []).join(", ");
        // Scroll al form
        form.scrollIntoView({ behavior: "smooth" });
      }

      function deleteBombero(id) {
        if (!confirm("¿Eliminar este bombero?")) return;
        personal = personal.filter((p) => p.id !== id);
        saveData(personal);
        renderAdminTable();
        renderDashboard();
      }

      $("#adminForm").addEventListener("submit", (e) => {
        e.preventDefault();
        const f = e.target;
        const id = f.id.value.trim();
        if (!id) return alert("ID requerido");
        const nombre = f.nombre.value.trim();
        const categoria = f.categoria.value;
        const compania = f.compania.value;
        const pin = f.pin.value.trim();
        if (!pin) return alert("PIN requerido");
        const foto = f.foto.value.trim();
        const cursos = f.cursos.value
          .split(",")
          .map((c) => c.trim())
          .filter((c) => c);

        let p = personal.find((x) => x.id === id);
        if (p) {
          // Editar
          p.nombre = nombre;
          p.categoria = categoria;
          p.compania = compania;
          p.pin = pin;
          p.foto = foto;
          p.cursos = cursos;
        } else {
          // Nuevo
          personal.push({
            id,
            nombre,
            categoria,
            compania,
            pin,
            estado: "fuera",
            enServicioDesde: null,
            totalMs: 0,
            historial: [],
            foto,
            fechaIngreso: nowISO(),
            cursos,
          });
        }
        saveData(personal);
        renderAdminTable();
        renderDashboard();
        f.reset();
      });

      renderDashboard();
    </script>
  </body>
</html>
